# LearnFlow - Architecture Documentation

## Table of Contents
1. [Project Overview](#project-overview)
2. [Directory Structure](#directory-structure)
3. [File Purposes](#file-purposes)
4. [Architecture Diagram](#architecture-diagram)
5. [Data Flow](#data-flow)
6. [Key Technologies](#key-technologies)
7. [API Provider System](#api-provider-system)

---

## Project Overview

LearnFlow is a Chrome Extension (Manifest v3) that provides AI-powered explanations for technical concepts, keeping users in their learning flow. Users can highlight text on any webpage, and the extension generates comprehensive explanations, examples, and interactive quizzes using either OpenAI's GPT-3.5 or Groq's Llama 3.3 (free).

**Key Features:**
- Text selection detection on any webpage
- Dual AI provider support (OpenAI GPT-3.5 / Groq Llama 3.3)
- Beautiful overlay UI directly on webpages
- Interactive quizzes with instant feedback
- Follow-up chat for deeper learning
- Save explanations as images (PNG export with full chat history)
- Auto-save topics when exporting images
- Settings page for API key configuration
- Extension context validation with user-friendly warnings
- Popup interface for saved topics management

---

## Directory Structure

```
studytoolDev/
â”œâ”€â”€ public/                      # Static assets copied to dist/
â”‚   â”œâ”€â”€ background.js           # Service worker (plain JS, not built by Vite)
â”‚   â”œâ”€â”€ manifest.json           # Chrome extension configuration
â”‚   â””â”€â”€ icons/                  # Extension icons (48x48, 128x128)
â”‚       â”œâ”€â”€ icon.png            # Source icon
â”‚       â”œâ”€â”€ icon48.png          # 48x48 toolbar icon
â”‚       â””â”€â”€ icon128.png         # 128x128 store/settings icon
â”‚
â”œâ”€â”€ src/                        # Source code (built by Vite)
â”‚   â”œâ”€â”€ components/             # React components
â”‚   â”‚   â”œâ”€â”€ Popup.tsx          # Main popup UI component
â”‚   â”‚   â””â”€â”€ Options.tsx        # Settings page with dual API support
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/               # Chrome extension scripts
â”‚   â”‚   â”œâ”€â”€ content.ts         # Content script (runs on webpages)
â”‚   â”‚   â””â”€â”€ background.ts      # TypeScript version (reference only)
â”‚   â”‚
â”‚   â”œâ”€â”€ styles/                # Global styles
â”‚   â”‚   â””â”€â”€ index.css          # Tailwind CSS imports
â”‚   â”‚
â”‚   â”œâ”€â”€ popup.tsx              # Popup entry point
â”‚   â””â”€â”€ options.tsx            # Options page entry point
â”‚
â”œâ”€â”€ dist/                       # Build output (generated by npm run build)
â”‚   â”œâ”€â”€ popup.html             # Popup HTML
â”‚   â”œâ”€â”€ options.html           # Options page HTML
â”‚   â”œâ”€â”€ background.js          # Service worker
â”‚   â”œâ”€â”€ manifest.json          # Extension manifest
â”‚   â”œâ”€â”€ icons/                 # Extension icons
â”‚   â”œâ”€â”€ scripts/               # Compiled scripts
â”‚   â”‚   â””â”€â”€ content.js         # Content script
â”‚   â””â”€â”€ assets/                # Bundled JS/CSS files
â”‚
â”œâ”€â”€ popup.html                  # Popup HTML template
â”œâ”€â”€ options.html                # Options page HTML template
â”œâ”€â”€ package.json                # NPM dependencies and scripts
â”œâ”€â”€ tsconfig.json               # TypeScript configuration
â”œâ”€â”€ vite.config.ts              # Vite build configuration
â”œâ”€â”€ tailwind.config.js          # Tailwind CSS configuration
â”œâ”€â”€ postcss.config.js           # PostCSS configuration
â”œâ”€â”€ README.md                   # Project overview and quick start
â”œâ”€â”€ USER_GUIDE.md               # Complete user documentation
â”œâ”€â”€ ARCHITECTURE.md             # This file
â””â”€â”€ .gitignore                  # Git ignore rules
```

---

## File Purposes

### Root Configuration Files

#### `package.json`
- **Purpose**: NPM package configuration
- **Contains**: Dependencies (React, Vite, TypeScript, Tailwind, html2canvas), build scripts
- **Key Scripts**:
  - `npm run build` - Builds the extension for production
  - `npm run watch` - Builds in watch mode for development
- **Key Dependencies**:
  - `html2canvas`: 1.4.1 - For image export functionality

#### `vite.config.ts`
- **Purpose**: Vite bundler configuration
- **Key Settings**:
  - Multiple entry points (popup, options, content script)
  - Output directory configuration (`dist/`)
  - Path aliases (`@/` â†’ `./src/`)
  - Custom output naming for scripts vs assets
- **Note**: Background worker is NOT built by Vite (uses plain JS)

#### `tsconfig.json`
- **Purpose**: TypeScript compiler configuration
- **Key Settings**:
  - Target: ES2020
  - JSX: React
  - Strict mode enabled
  - Chrome API types included

#### `tailwind.config.js`
- **Purpose**: Tailwind CSS configuration
- **Scans**: All HTML and TSX files for class names
- **Output**: Optimized CSS with only used utilities

---

### Public Directory (Static Assets)

#### `public/manifest.json`
- **Purpose**: Chrome extension configuration (Manifest v3)
- **Defines**:
  - Extension name: "LearnFlow"
  - Permissions: storage, activeTab, scripting, host_permissions (https://*/*)
  - Service worker: `background.js`
  - Content scripts: injected into all URLs
  - Popup: `popup.html`
  - Options page: `options.html`
  - Icons: 48x48 and 128x128 only (Chrome auto-scales for toolbar)
- **Copied to**: `dist/manifest.json` during build

#### `public/background.js`
- **Purpose**: Service worker (background script)
- **Type**: Plain JavaScript (NOT processed by Vite)
- **Responsibilities**:
  1. Listens for messages from content script and popup
  2. Loads API settings (selectedApi, openaiApiKey, groqApiKey) from Chrome storage
  3. Determines which AI provider to use based on user selection
  4. Makes API calls to OpenAI OR Groq
  5. Returns explanations to content script/popup
  6. Stores explanations in Chrome storage
  7. Handles chat messages with context
- **Key Functions**:
  - `handleExplanationRequest(text)` - Calls selected AI API with explanation prompt
  - `handleChatMessage(question, context)` - Calls selected AI API for follow-up questions
  - Message handlers for `REQUEST_EXPLANATION`, `SET_API_KEY`, `CHAT_MESSAGE`
- **API Selection Logic**:
  ```javascript
  // Lines 62-64: Determine which API to use
  const selectedApi = result.selectedApi || 'openai';
  const apiKey = selectedApi === 'groq' ? result.groqApiKey : result.openaiApiKey;

  // Lines 95-107: Configure endpoint and model
  const apiConfig = selectedApi === 'groq'
    ? {
        endpoint: 'https://api.groq.com/openai/v1/chat/completions',
        model: 'llama-3.3-70b-versatile',  // Groq: Latest free model
        provider: 'Groq'
      }
    : {
        endpoint: 'https://api.openai.com/v1/chat/completions',
        model: 'gpt-3.5-turbo',  // OpenAI: Paid model
        provider: 'OpenAI'
      };
  ```
- **Why Plain JS**: Service workers in Chrome have specific requirements; avoiding Vite build issues

#### `public/icons/`
- **Purpose**: Extension icons in multiple sizes
- **Sizes**: 48x48 (toolbar), 128x128 (store/settings)
- **Note**: Chrome auto-scales 48x48 for 16x16 and 32x32 contexts
- **Format**: PNG with transparent background

---

### Source Files (Built by Vite)

#### `src/popup.tsx`
- **Purpose**: Entry point for popup UI
- **What It Does**:
  - Imports React and Popup component
  - Renders `<Popup />` into `#root` div
  - Imports global styles

#### `src/options.tsx`
- **Purpose**: Entry point for options/settings page
- **What It Does**:
  - Imports React and Options component
  - Renders `<Options />` into `#root` div
  - Imports global styles

#### `src/components/Popup.tsx`
- **Purpose**: Main popup UI component
- **Features**:
  - Displays last explanation (within 5 min expiry)
  - Interactive quiz section with answer validation
  - Saved topics display with delete functionality
  - Auto-refreshes when new explanation generated
- **State Management**:
  - `explanation` - Current explanation data
  - `savedTopics` - Array of saved topic names
  - `selectedAnswer` - Quiz answer selection
  - `showResult` - Quiz result visibility
- **Chrome API Usage**:
  - `chrome.storage.local` - Load/save data
  - `chrome.runtime.onMessage` - Listen for explanations
- **Key Changes**:
  - **Removed** "Explain Selected Text" button (redundant with content script indicator)
  - **Added** delete functionality for saved topics (âœ• button)

#### `src/components/Options.tsx`
- **Purpose**: Settings page for dual API provider configuration
- **Features**:
  - API provider selector (OpenAI vs Groq)
  - Separate API key inputs for each provider
  - Show/hide key toggle
  - Save and clear buttons
  - Success/error status messages
  - Provider-specific instructions and cost info
- **State Management**:
  - `selectedApi` - Current API provider ('openai' | 'groq')
  - `openaiKey` - OpenAI API key input
  - `groqKey` - Groq API key input
  - `savedOpenaiKey` - Stored OpenAI key
  - `savedGroqKey` - Stored Groq key
  - `saveStatus` - Save operation status
  - `showOpenaiKey` / `showGroqKey` - Show/hide toggles
- **Chrome API Usage**:
  - `chrome.storage.sync` - Store API keys and selectedApi (synced across devices)
- **UI Layout**:
  - Two-column provider selector (OpenAI / Groq)
  - Dynamic form based on selected provider
  - Green badge for Groq ("FREE & Fast")
  - Blue badge for OpenAI ("Best quality, paid")

#### `src/scripts/content.ts`
- **Purpose**: Content script injected into all webpages
- **Responsibilities**:
  1. Detects text selection on page
  2. Shows blue indicator when text is selected
  3. Validates extension context (detects invalidation)
  4. Sends explanation request when indicator clicked
  5. Displays explanation overlay on the page
  6. Handles chat messages within overlay
  7. Exports explanations as PNG images with html2canvas
  8. Auto-saves topics when image exported
- **Key Functions**:
  - `isExtensionContextValid()` - Checks chrome.runtime.id to detect invalidation
  - `safeSendMessage(message, callback)` - Wrapper with context validation
  - `showSelectionIndicator(text)` - Creates blue indicator
  - `showExplanationOverlay(explanation)` - Creates modal overlay with full features
  - `showNotification(message, bgColor)` - Shows toast notification at bottom: 80px (above indicator)
- **Event Listeners**:
  - `mouseup` - Detects text selection
  - `keydown` - Keyboard shortcut (Ctrl+Shift+E)
  - Message listener for popup communication
- **Chrome API Usage**:
  - `chrome.runtime.sendMessage` - Request explanations from background (with validation)
  - `chrome.runtime.onMessage` - Receive messages from popup
  - `chrome.storage.local` - Save topics when exporting images
- **UI Elements Created**:
  - Blue indicator (fixed bottom-right)
  - Modal overlay (centered, dark backdrop)
  - Quiz buttons (interactive with hover states)
  - Chat interface (input + send button + message history)
  - Save as Image button (exports full overlay including chat)
  - Orange warning notification when extension context invalidates
- **Image Export**:
  - Uses `html2canvas` library
  - Creates temporary clone of overlay (no height restrictions)
  - Expands chat messages container to show all messages
  - Saves with filename: `LearnFlow_[Term]_[Timestamp].png`
  - Auto-adds term to savedTopics in chrome.storage.local

#### `src/scripts/background.ts`
- **Purpose**: TypeScript reference implementation
- **Status**: NOT USED in build (public/background.js is copied instead)
- **Why It Exists**: Documentation and type checking reference
- **Note**: Kept in sync with public/background.js for consistency

#### `src/styles/index.css`
- **Purpose**: Global stylesheet
- **Contains**:
  - Tailwind CSS imports (@tailwind directives)
  - Global font settings
  - Body and #root styles

---

### HTML Templates

#### `popup.html`
- **Purpose**: HTML template for extension popup
- **Structure**:
  - Single `<div id="root">` for React mounting
  - Script import: `/src/popup.tsx`
- **Built Output**: `dist/popup.html` with hashed asset references

#### `options.html`
- **Purpose**: HTML template for settings page
- **Structure**:
  - Single `<div id="root">` for React mounting
  - Script import: `/src/options.tsx`
- **Built Output**: `dist/options.html` with hashed asset references

---

### Build Output (dist/)

#### `dist/` Directory
- **Purpose**: Production build output (load this in Chrome)
- **Generated By**: `npm run build`
- **Contents**:
  - `manifest.json` - Copied from public/
  - `background.js` - Copied from public/
  - `icons/` - Copied from public/icons/
  - `popup.html` - Built by Vite
  - `options.html` - Built by Vite
  - `scripts/content.js` - Compiled TypeScript
  - `assets/*.js` - Bundled React code (popup, options)
  - `assets/*.css` - Compiled Tailwind CSS
- **Load in Chrome**: Extensions â†’ Load unpacked â†’ Select `dist/` folder

---

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER INTERACTION                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Select Text    â”‚      â”‚  Click Extensionâ”‚
        â”‚  on Webpage     â”‚      â”‚     Icon        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Content Script  â”‚      â”‚  Popup Window   â”‚
        â”‚  (content.ts)   â”‚      â”‚   (Popup.tsx)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                       â”‚
                 â”‚  Shows Blue Indicator â”‚
                 â”‚  User Clicks It       â”‚
                 â”‚                       â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Background Worker â”‚
                   â”‚  (background.js)   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   Chrome Storage   â”‚
                   â”‚   Load API Config  â”‚
                   â”‚  (selectedApi key) â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   Groq API    â”‚    â”‚ OpenAI API  â”‚
          â”‚ (Llama 3.3)   â”‚    â”‚(GPT-3.5)    â”‚
          â”‚     FREE      â”‚    â”‚    Paid     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Parse JSON Result â”‚
                   â”‚  Store in Chrome   â”‚
                   â”‚      Storage       â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Show Overlay   â”‚      â”‚  Update Popup   â”‚
        â”‚   on Webpage    â”‚      â”‚   (if open)     â”‚
        â”‚                 â”‚      â”‚                 â”‚
        â”‚  - Definition   â”‚      â”‚  - Quiz         â”‚
        â”‚  - Examples     â”‚      â”‚  - Saved Topics â”‚
        â”‚  - Quiz         â”‚      â”‚                 â”‚
        â”‚  - Chat         â”‚      â”‚                 â”‚
        â”‚  - Save Image   â”‚      â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow

### 1. User Selects Text Flow (Primary Flow)

```
User selects "hash map" on webpage
           â†“
Content script detects selection (mouseup event)
           â†“
Content script validates extension context
           â†“
Blue indicator appears at bottom-right ("ğŸ“š Explain")
           â†“
User clicks blue indicator
           â†“
Loading animation appears ("âœ¨ Generating explanation...")
           â†“
Content script sends message via safeSendMessage():
  - Validates chrome.runtime.id exists
  - Sends REQUEST_EXPLANATION with selected text
           â†“
Background worker receives message
           â†“
Loads from chrome.storage.sync:
  - selectedApi ('openai' or 'groq')
  - openaiApiKey or groqApiKey
           â†“
Determines API config based on selectedApi:
  - Groq: api.groq.com + llama-3.3-70b-versatile
  - OpenAI: api.openai.com + gpt-3.5-turbo
           â†“
Makes POST request to selected AI provider
           â†“
Receives JSON response with explanation
           â†“
Stores in chrome.storage.local:
  - lastExplanation (full explanation object)
  - lastExplanationTime (Date.now())
           â†“
Sends response back to content script
           â†“
Content script creates overlay with:
  - Term and definition
  - 3 examples
  - Interactive quiz
  - Chat interface
  - Save as Image button
           â†“
User can:
  - Take quiz
  - Ask follow-up questions in chat
  - Save as PNG image (includes all chat history)
```

### 2. Chat Flow (Follow-up Questions)

```
User views explanation overlay
           â†“
User types question in chat input
           â†“
User presses Enter or clicks send
           â†“
Content script sends CHAT_MESSAGE:
  - question: user's question
  - context: current term being learned
           â†“
Background worker receives message
           â†“
Loads API config (same as explanation flow)
           â†“
Makes API call with context-aware system prompt:
  "You are a tutor. User is learning about '[term]'..."
           â†“
Receives answer
           â†“
Sends response back to content script
           â†“
Content script appends to chat history:
  - User message (blue bubble)
  - AI response (gray bubble)
           â†“
Chat scrolls to latest message
```

### 3. Save as Image Flow

```
User clicks "ğŸ’¾ Save as Image" button
           â†“
Content script creates clone of explanation card:
  - Positions clone off-screen (-10000px)
  - Removes max-height restrictions
  - Expands chat messages container (all messages visible)
           â†“
html2canvas captures clone as canvas
           â†“
Canvas converted to PNG blob
           â†“
Creates download link with filename:
  "LearnFlow_[term]_[timestamp].png"
           â†“
Triggers download
           â†“
Removes clone from DOM
           â†“
Adds term to chrome.storage.local.savedTopics
  (if not already present)
           â†“
Topic appears in popup's "Saved Topics" list
```

### 4. User Opens Popup Flow

```
User clicks extension icon
           â†“
popup.html loads and mounts Popup.tsx
           â†“
Popup component loads from chrome.storage.local:
  - lastExplanation
  - lastExplanationTime
  - savedTopics
           â†“
Checks if lastExplanationTime is within 5 minutes
           â†“
If yes, displays the explanation with quiz
If no, shows welcome message
           â†“
Displays saved topics as blue chips with âœ• buttons
           â†“
User can click âœ• to delete a topic:
  - Filters topic from array
  - Updates chrome.storage.local.savedTopics
```

### 5. API Key Configuration Flow

```
User right-clicks extension â†’ Options
           â†“
options.html loads and mounts Options.tsx
           â†“
Loads from chrome.storage.sync:
  - selectedApi ('openai' or 'groq')
  - openaiApiKey
  - groqApiKey
           â†“
User selects API provider (Groq or OpenAI)
           â†“
Form updates to show relevant key input
           â†“
User enters API key and clicks "Save"
           â†“
Saves to chrome.storage.sync:
  {
    selectedApi: 'groq',      // or 'openai'
    groqApiKey: 'gsk_...',    // if Groq selected
    // OR
    openaiApiKey: 'sk-...'    // if OpenAI selected
  }
           â†“
Shows "âœ“ Saved!" confirmation (green)
           â†“
Background worker will use new config on next request
```

### 6. Extension Context Invalidation Flow

```
Extension gets updated/reloaded while user has webpage open
           â†“
chrome.runtime.id becomes undefined
           â†“
User tries to select text and click indicator
           â†“
Content script calls safeSendMessage()
           â†“
isExtensionContextValid() returns false
           â†“
Shows orange warning notification:
  "âš ï¸ Extension updated. Please refresh this page."
           â†“
Message send is aborted (prevents error)
           â†“
User refreshes page
           â†“
Content script reloads with valid context
           â†“
Extension functions normally again
```

---

## Key Technologies

### Frontend
- **React 18.3.1** - UI component library
- **TypeScript 5.7.2** - Type-safe JavaScript
- **Tailwind CSS 3.4.17** - Utility-first CSS framework
- **html2canvas 1.4.1** - HTML to canvas/image conversion
- **Vite 5.4.11** - Fast build tool and bundler

### Chrome Extension APIs
- **chrome.storage** - Store API keys and explanations
  - `sync` - API keys, selectedApi (synced across devices)
  - `local` - Explanations, saved topics (local only)
- **chrome.runtime** - Message passing between components
  - `sendMessage()` - Send messages
  - `onMessage.addListener()` - Receive messages
  - `id` - Extension context validation
- **chrome.tabs** - Communicate with content scripts
- **Manifest v3** - Latest Chrome extension format

### External APIs

#### Groq API (Free Option)
- **Endpoint**: `https://api.groq.com/openai/v1/chat/completions`
- **Model**: `llama-3.3-70b-versatile`
- **Cost**: FREE with rate limits (~30 requests/minute)
- **Speed**: Very fast (optimized inference)
- **Use Case**: Perfect for students and learning

#### OpenAI API (Premium Option)
- **Endpoint**: `https://api.openai.com/v1/chat/completions`
- **Model**: `gpt-3.5-turbo`
- **Cost**: ~$0.001-0.003 per explanation
- **Speed**: Fast
- **Use Case**: Best quality responses

### Build Tools
- **Vite** - Module bundler and dev server
- **PostCSS** - CSS processing
- **Autoprefixer** - Adds vendor prefixes to CSS
- **TypeScript Compiler** - Compiles TS to JS

---

## API Provider System

### How API Selection Works

1. **User Configuration** (Options.tsx)
   - User selects provider: Groq or OpenAI
   - User enters corresponding API key
   - Saves to `chrome.storage.sync`:
     ```javascript
     {
       selectedApi: 'groq',        // or 'openai'
       groqApiKey: 'gsk_...',      // Groq key
       openaiApiKey: 'sk-...'      // OpenAI key
     }
     ```

2. **Background Worker** (background.js)
   - Loads config on each request (lines 60-64)
   - Determines API to use:
     ```javascript
     const selectedApi = result.selectedApi || 'openai';
     const apiKey = selectedApi === 'groq'
       ? result.groqApiKey
       : result.openaiApiKey;
     ```
   - Configures endpoint and model (lines 95-107):
     ```javascript
     const apiConfig = selectedApi === 'groq'
       ? { endpoint: '...groq...', model: 'llama-3.3-70b-versatile' }
       : { endpoint: '...openai...', model: 'gpt-3.5-turbo' };
     ```

3. **API Call** (lines 114-136)
   - Makes POST request to `apiConfig.endpoint`
   - Uses `apiConfig.model` in request body
   - Uses appropriate API key in Authorization header

4. **Logging** (for debugging)
   ```
   [LearnFlow] Selected API: groq
   [LearnFlow] API Key exists: true
   [LearnFlow] Using Groq API
   [LearnFlow] Endpoint: https://api.groq.com/openai/v1/chat/completions
   [LearnFlow] Model: llama-3.3-70b-versatile
   ```

### API Compatibility

Both APIs use OpenAI-compatible format:
- Same request structure
- Same response structure
- Groq endpoint uses `/openai/v1/` path for compatibility

---

## Message Passing Architecture

Chrome extensions use message passing for communication between isolated contexts:

### Message Types

#### 1. `REQUEST_EXPLANATION`
- **From**: Content script
- **To**: Background worker
- **Payload**: `{ type: 'REQUEST_EXPLANATION', text: string }`
- **Response**: `{ success: boolean, data: Explanation, error?: string }`
- **Used For**: Initial term explanation request

#### 2. `CHAT_MESSAGE`
- **From**: Content script (chat interface)
- **To**: Background worker
- **Payload**: `{ type: 'CHAT_MESSAGE', question: string, context: string }`
- **Response**: `{ success: boolean, answer: string, error?: string }`
- **Used For**: Follow-up questions within explanation overlay

#### 3. `EXPLANATION_GENERATED`
- **From**: Background worker
- **To**: Popup (if open)
- **Payload**: `{ type: 'EXPLANATION_GENERATED', data: Explanation }`
- **Purpose**: Notify popup that explanation is ready

#### 4. `SET_API_KEY`
- **From**: Options page
- **To**: Background worker
- **Payload**: `{ type: 'SET_API_KEY', apiKey: string }`
- **Response**: `{ success: boolean }`
- **Note**: Legacy support (storage is primary method)

---

## Chrome Storage Schema

### chrome.storage.sync (Synced across devices)
```javascript
{
  selectedApi: 'openai' | 'groq',  // Currently selected AI provider
  openaiApiKey: string,             // OpenAI API key (sk-...)
  groqApiKey: string                // Groq API key (gsk_...)
}
```

### chrome.storage.local (Local only)
```javascript
{
  lastExplanation: Explanation,    // Most recent explanation
  lastExplanationTime: number,     // Timestamp (Date.now())
  savedTopics: string[]            // Array of saved topic names
}
```

### Explanation Type
```typescript
interface Explanation {
  term: string;
  definition: string;              // Markdown supported
  examples: string[];              // Array of 3 examples
  quizQuestion?: string;
  quizOptions?: string[];          // Array of 4 options
  quizAnswer?: number;             // Index of correct answer (0-3)
}
```

---

## Security Considerations

1. **API Key Storage**: Stored in `chrome.storage.sync` (encrypted by Chrome)
2. **No API Key in Code**: Never hardcoded in source files
3. **Content Security Policy**: Enforced by Manifest v3
4. **Host Permissions**: Only HTTPS sites allowed
5. **Service Worker Isolation**: Background script runs in isolated context
6. **No eval()**: Vite build doesn't use eval for security
7. **Context Validation**: Extension checks for invalidation before message passing
8. **User Control**: Users provide own API keys, no central server

---

## Build Process

### Development
```bash
npm run dev     # Starts Vite dev server (for component testing)
npm run watch   # Builds extension in watch mode
```

### Production
```bash
npm run build   # Compiles TypeScript, bundles with Vite, copies static files
```

### Build Steps:
1. TypeScript compiler (`tsc`) checks types
2. Vite bundles React components (popup, options, content script)
3. Tailwind CSS compiles used utilities
4. Copies `public/background.js` to `dist/`
5. Copies `public/manifest.json` to `dist/`
6. Copies `public/icons/` to `dist/icons/`
7. Outputs everything to `dist/` folder

### Loading in Chrome:
1. Open `chrome://extensions/`
2. Enable "Developer mode"
3. Click "Load unpacked"
4. Select the `dist/` folder
5. Extension appears in toolbar

---

## Troubleshooting

### Common Issues

**Issue**: Service worker inactive
- **Cause**: Normal behavior - service workers sleep when idle
- **Fix**: No fix needed - activates when needed

**Issue**: "Extension context invalidated"
- **Cause**: Extension reloaded while page was open
- **Fix**: Refresh the webpage (LearnFlow shows orange warning)

**Issue**: API key not working
- **Cause**: Wrong API provider selected or key format incorrect
- **Fix**:
  - Check Options page matches your key type
  - Groq keys start with `gsk_`
  - OpenAI keys start with `sk-`

**Issue**: Popup doesn't open
- **Cause**: Absolute paths in HTML
- **Fix**: Set `base: './'` in vite.config.ts (already done)

**Issue**: Extension doesn't work on PDF files
- **Cause**: Chrome's built-in PDF viewer blocks content scripts
- **Fix**: This is a Chrome limitation. Workarounds:
  - Copy PDF text to a regular webpage
  - Use web-based PDF viewers

**Issue**: Image export is cropped
- **Cause**: Old version of LearnFlow
- **Fix**: Use latest version which creates off-screen clone with no height restrictions

**Issue**: Chat messages not in saved image
- **Cause**: Old version of LearnFlow
- **Fix**: Use latest version which expands chat container before capture

**Issue**: Icon looks pixelated in toolbar
- **Cause**: Icon too small or low quality
- **Fix**: Use 48x48 source icon, Chrome auto-scales

---

## Feature Checklist

### Implemented Features
- [x] Text selection detection
- [x] Blue indicator for selected text
- [x] AI explanations (OpenAI GPT-3.5)
- [x] AI explanations (Groq Llama 3.3)
- [x] Dual API provider support
- [x] Interactive quizzes with validation
- [x] Follow-up chat interface
- [x] Save explanations as PNG images
- [x] Auto-save topics when exporting
- [x] Delete saved topics
- [x] Extension context validation
- [x] User-friendly error notifications
- [x] Icons (48x48, 128x128)
- [x] Markdown code formatting in explanations
- [x] Settings page with API selector
- [x] Popup with saved topics

### Future Enhancements

Potential features to add:
- [ ] Dark mode toggle
- [ ] Additional AI providers (Claude, Gemini)
- [ ] Explanation history view
- [ ] Export topics as JSON
- [ ] Keyboard shortcuts customization
- [ ] Multi-language support
- [ ] Offline mode with cached explanations
- [ ] Study session statistics
- [ ] Spaced repetition for saved topics

---

## License

MIT

---

## Documentation

- **README.md** - Project overview and quick start
- **USER_GUIDE.md** - Complete user documentation with setup, usage, tips, troubleshooting
- **ARCHITECTURE.md** - This file (technical architecture)

---

## Contact

Project: [https://github.com/keeeeeliu/LearnFlow](https://github.com/keeeeeliu/LearnFlow)
